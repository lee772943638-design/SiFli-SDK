#include <stdint.h>
#include <string.h>
#include "bf0_hal.h"
#include "mem_map.h"
#include "register.h"
#include "bf0_hal_patch.h"
#ifdef HAL_LCPU_PATCH_MODULE
static const unsigned int g_lcpu_patch_list[] =
{
    0x50544348, 0x00000068, 0x00057830, 0x63682032,
    0x000062C8, 0xBEAAF3FE, 0x0001ABBC, 0xBA33F3EA,
    0x00024D00, 0xB99AF3E0, 0x00047960, 0x210048DF,
    0x00021D84, 0xB969F3E3, 0x000397A4, 0xBC63F3CB,
    0x00059350, 0xBEE4F3AB, 0x000309A0, 0xBB7FF3D4,
    0x0002E344, 0xBEBCF3D6, 0x0001BC08, 0xBA72F3E9,
    0x00021EFC, 0xB901F3E3, 0x00025528, 0xBE0DF3DF,
};

static const unsigned int g_lcpu_patch_bin[] =
{
    0xF000B580, 0x4802FA09, 0x7001210C, 0xBF00BD80,
    0x20400990, 0xB8A0F000, 0x46514770, 0xF8D8F000,
    0xF64A4604, 0xF2C031C1, 0x47080101, 0x07F8D10A,
    0x4620D103, 0xF4042101, 0xF644FA73, 0xF2C0110F,
    0x47080102, 0x5105F644, 0x0102F2C0, 0xB5704708,
    0xF0004604, 0x4620F8B7, 0x5289F641, 0x0202F2C0,
    0xF2424710, 0x44087110, 0x46689004, 0x71A9F249,
    0x0103F2C0, 0x69AC4708, 0xBF8842A2, 0x2B7C4622,
    0xF64DD804, 0xF2C0345D, 0x47200402, 0x3471F64D,
    0x0402F2C0, 0x46284720, 0xF902F000, 0xBF884290,
    0xB2904602, 0xF8AD8A61, 0xF6402012, 0xF2C012A9,
    0x47100203, 0x460B4658, 0xF8F2F000, 0x42884619,
    0x4601BF88, 0x1010F8AA, 0x460B8A60, 0x428B0041,
    0x4619BF88, 0xBF882904, 0xF24E460A, 0xF2C03351,
    0x47180302, 0xF000B406, 0xBC06F851, 0x4323F64B,
    0x0301F2C0, 0xB1354718, 0x7164F8D5, 0x7601F641,
    0x0602F2C0, 0xF6414730, 0xF2C0762B, 0x47300602,
    0xD80B4559, 0x800AF8A6, 0x0109EB08, 0xF881FA1F,
    0xBF8C45D8, 0xB00CF8A6, 0xE00181B1, 0x0003F04F,
    0x2145F249, 0x0105F2C0, 0xF04F4708, 0xF00002FF,
    0xF245F883, 0xF2C0512F, 0x47080102, 0x2803491B,
    0x2100BF18, 0x47704608, 0x460CB5B0, 0xF7FB4605,
    0x6829F00B, 0x6869B109, 0x4629E000, 0x2100600C,
    0x6021606C, 0x40B0E8BD, 0xB002F7FB, 0x68002100,
    0x3101B108, 0xB288E7FB, 0x00004770, 0xEBB2227F,
    0xD1060F50, 0x490A7848, 0x0040EB00, 0x0080EB01,
    0x08414770, 0x4B044805, 0x0241EB01, 0xBF182903,
    0x0082EB03, 0xBF004770, 0x0005E554, 0x00405508,
    0x0005E878, 0x01C5F891, 0x0039F881, 0x00004770,
    0x460DB5B0, 0xF7FA4604, 0x491AF7CF, 0xF8516809,
    0x25001025, 0xF891B169, 0x4A091096, 0x0141EB01,
    0x1141EA42, 0x8CD24ABF, 0x04495A89, 0xF44FBF58,
    0xF7FA75C8, 0x1C60F7BD, 0x0001F020, 0xBDB04428,
    0x20408006, 0x6809490B, 0x0020F851, 0xF890B130,
    0x38030099, 0xF080FAB0, 0x47700940, 0x47702000,
    0x4904B2C8, 0xF8516809, 0x28000020, 0x2001BF18,
    0xBF004770, 0x20400328, 0x41F0E92D, 0x460D4690,
    0xF7FA4606, 0x4607F791, 0x30084809, 0xFF8EF7FF,
    0x46384604, 0xF78CF7FA, 0xBF882C0A, 0x81F0E8BD,
    0x46294630, 0xE8BD4642, 0xF41441F0, 0xBF00BB0D,
    0x20400588, 0x499CB150, 0x3039F891, 0x203BF891,
    0xC020F8D1, 0x1096F890, 0x47602000, 0xBF004770,
    0x68094907, 0x0020F851, 0x6E40B138, 0x2171F240,
    0x709CF500, 0xF0F1FBB0, 0x20004770, 0xBF004770,
    0x204002F4, 0x6809491A, 0x0020F851, 0x8D01B138,
    0xF8B0B129, 0x42810052, 0xF7FFBF18, 0x4770B7B3,
    0x41F0E92D, 0x460E4615, 0xF7FA4607, 0xF8DFF745,
    0x46048040, 0x0000F8D8, 0x1027F850, 0xF891B199,
    0xB1500057, 0xB1288D08, 0xF79CF7FF, 0x0000F8D8,
    0x1027F850, 0x854E850D, 0x4638E005, 0x462A4631,
    0xF4382301, 0x4620FF0F, 0x41F0E8BD, 0xB728F7FA,
    0x204002FC, 0x4605B570, 0x460C7840, 0xD1132818,
    0x0A20490C, 0xF8516809, 0xF8966020, 0x28010036,
    0x4620D10A, 0xFAD8F414, 0xD0052832, 0x003CF896,
    0xBF1C2802, 0xBD702000, 0x46214628, 0x4070E8BD,
    0xB9F8F445, 0x20400318, 0x4614B510, 0xD0092807,
    0xD00E2831, 0xBF08280D, 0xD1122910, 0xF7FFB2D8,
    0xE00CFF99, 0x2F00F5B1, 0x4618D10B, 0xFF72F7FF,
    0xF5B1E005, 0xD1044F80, 0xF0004618, 0x2001F82F,
    0x2000E000, 0xBD107020, 0x4614B5B0, 0x2100460A,
    0x70212813, 0x1504E9DD, 0x280DD005, 0xF5B2BF08,
    0xD00C7F80, 0xF5B2BDB0, 0xD1FB3F80, 0x4618B2EA,
    0xFF26F7FF, 0xBF042801, 0x70202001, 0xB2D8BDB0,
    0xB2AAB2C9, 0x40B0E8BD, 0xBF72F7FF, 0x70102000,
    0x47702000, 0x70102000, 0x00004770, 0x62414901,
    0xBF004770, 0x00405481, 0x490E480D, 0x480E6001,
    0x6001490E, 0x490F480E, 0x480F6001, 0x6001490F,
    0xF244480F, 0xF8C00104, 0xF44F10C4, 0x63417188,
    0x3180F44F, 0xF44F64C1, 0x61C12100, 0xBF004770,
    0x20400198, 0x00405385, 0x204001B8, 0x00405411,
    0x204001A8, 0x004053C5, 0x204001AC, 0x00405409,
    0x204008A8, 0x2801B5F8, 0x4614D137, 0xF44A460D,
    0x42A8FF5D, 0x4628D92C, 0xFEC4F7FF, 0xD1272801,
    0x0245EB05, 0x49164C17, 0xEA414F17, 0x8CE51342,
    0xF4205B58, 0xF8976600, 0xF8970039, 0xEA46703B,
    0x2F0126C7, 0xEA4F535E, 0x8CE21342, 0x3114BF1F,
    0x5A8B4319, 0x03FFF023, 0x4418BF11, 0x43193106,
    0xBF045A8B, 0x03E0F023, 0x1040EA43, 0xE0045288,
    0x46292001, 0xF4554622, 0x2000FC21, 0xBF00BDF8,
    0x20408000, 0x204000F8, 0x2040156C, 0x00405341,
    0x00405524, 0x00000082, 0x00040008, 0x00100040,
    0x002C0050, 0x01CE02D0, 0x00004242,
};
void lcpu_patch_install_rev_b()
{
    uint32_t entry[3] = {0x48434150, 0xC, LCPU_PATCH_CODE_START_ADDR + 1};
    memcpy((void *)LCPU_PATCH_BUF_START_ADDR, (void *)&entry, 12);
#ifdef SOC_BF0_HCPU
    memset((void *)(LCPU_PATCH_CODE_START_ADDR_S), 0, LCPU_PATCH_CODE_SIZE);
    memcpy((void *)(LCPU_PATCH_CODE_START_ADDR_S), g_lcpu_patch_bin, sizeof(g_lcpu_patch_bin));
#else
    memset((void *)(LCPU_PATCH_CODE_START_ADDR), 0, LCPU_PATCH_CODE_SIZE);
    memcpy((void *)(LCPU_PATCH_CODE_START_ADDR), g_lcpu_patch_bin, sizeof(g_lcpu_patch_bin));
#endif
    HAL_PATCH_install();
}
uint32_t *HAL_PATCH_GetEntryAddr(void)
{
    uint32_t *entry_addr = (uint32_t *)LCPU_PATCH_RECORD_ADDR;
    uint8_t rev_id = __HAL_SYSCFG_GET_REVID();
    if (rev_id >= HAL_CHIP_REV_ID_A4)
        entry_addr = (uint32_t *)g_lcpu_patch_list;
    return entry_addr;
}
#endif
